machine:
  kubelet:
    nodeIP:
      validSubnets:
        - ${subnet}
  certSANs:
    - ${loadbalancerdns}
    - ${hostdns}
  time:
    servers:
      - time.cloudflare.com

cluster:
  allowSchedulingOnControlPlanes: true
  apiServer:
    admissionControl:
      - name: PodSecurity
        configuration:
          exemptions:
            namespaces:
              - cilium-test # to run cilium connectivity tests
  network:
    cni:
      name: none
  proxy:
    disabled: true
  inlineManifests:
    - name: fluence
      contents: |-
        ---
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: terraform-config
          namespace: flux-system
        data:
          DOMAIN: ${domain}
          LOADBALANCER_IP: ${loadbalancerip}
          BRANCH: ${branch}
          PREFIX: ${prefix}
          DOTOKEN: ${dotoken}
          PR_URL: ${pr_url}
        ---
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: deploy-spectrum
          namespace: flux-system
        spec:
          interval: 1m0s
          path: "./flux/clusters/ephemeral"
          prune: true
          sourceRef:
            kind: GitRepository
            name: spectrum
            namespace: flux-system
          validation: client
          timeout: 2m
          postBuild:
            substituteFrom:
            - kind: ConfigMap
              name: terraform-config
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: docker-auth
          namespace: default
        type: kubernetes.io/dockerconfigjson
        data:
          .dockerconfigjson: ${docker}
